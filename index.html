<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Creationism - Text to 3D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }
      .loading-dot {
        animation: pulse 1.5s infinite;
      }
      .loading-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .loading-dot:nth-child(3) {
        animation-delay: 0.4s;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto">
      <div class="text-center mb-12">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">
          Creationism - Text to 3D
        </h1>
        <p class="text-lg text-gray-600">
          Enter your description to generate a 3D model
        </p>
      </div>

      <form id="textForm" class="mb-8">
        <div class="flex gap-4">
          <input
            type="text"
            id="userInput"
            placeholder="Describe your 3D model..."
            required
            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
          <button
            type="submit"
            class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            Generate
          </button>
        </div>
      </form>

      <div id="loader" class="hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
          <div class="flex items-center justify-center mb-4">
            <div class="flex space-x-2">
              <div class="w-3 h-3 bg-blue-600 rounded-full loading-dot"></div>
              <div class="w-3 h-3 bg-blue-600 rounded-full loading-dot"></div>
              <div class="w-3 h-3 bg-blue-600 rounded-full loading-dot"></div>
            </div>
          </div>
          <p class="text-lg text-center text-gray-700 mb-4">
            Creating your 3D model... This might take around 6 minutes üòä
          </p>
          <p class="text-center text-gray-500">
            Why not grab a cup of coffee? ‚òïÔ∏è
          </p>
          <div class="mt-6">
            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
              <div
                id="progressBar"
                class="h-full bg-blue-600 transition-all duration-1000"
                style="width: 0%"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <div id="result" class="mb-8"></div>

      <canvas
        id="threeCanvas"
        class="w-full h-[600px] rounded-lg shadow-lg bg-white"
      ></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/jsm/loaders/OBJLoader.js"></script>

    <script>
      // Replace with your WebSocket URL from CloudFormation output
      const wsUrl = "YOUR_WEBSOCKET_URL";
      let ws;
      let progressInterval;

      function startProgressAnimation() {
        const progressBar = document.getElementById("progressBar");
        let progress = 0;
        const totalTime = 360; // 6 minutes in seconds
        const increment = 100 / totalTime;

        progressInterval = setInterval(() => {
          progress += increment;
          if (progress > 98) {
            clearInterval(progressInterval);
          } else {
            progressBar.style.width = `${progress}%`;
          }
        }, 1000);
      }

      function stopProgressAnimation() {
        if (progressInterval) {
          clearInterval(progressInterval);
          document.getElementById("progressBar").style.width = "100%";
        }
      }

      function connectWebSocket() {
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          console.log("Connected to WebSocket");
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          const loader = document.getElementById("loader");
          const result = document.getElementById("result");

          if (data.statusMessage) {
            result.innerHTML = `
              <div class="bg-white p-4 rounded-lg shadow text-gray-700">
                ${data.statusMessage}
              </div>
            `;
          } else if (data.error) {
            stopProgressAnimation();
            loader.classList.add("hidden");
            result.innerHTML = `
              <div class="bg-red-50 p-4 rounded-lg text-red-700 border border-red-200">
                ${data.error}
              </div>
            `;
          } else if (data.finalModelUrl) {
            stopProgressAnimation();
            loader.classList.add("hidden");
            result.innerHTML = `
              <div class="bg-green-50 p-4 rounded-lg text-green-700 border border-green-200 mb-4">
                3D model generated successfully! Loading into viewer... üéâ
              </div>
            `;
            load3DModel(data.finalModelUrl);
          }
        };

        ws.onclose = () => {
          console.log("WebSocket connection closed");
          setTimeout(connectWebSocket, 3000);
        };
      }

      // Three.js setup
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0xffffff);

      const canvas = document.getElementById("threeCanvas");
      const camera = new THREE.PerspectiveCamera(
        75,
        canvas.clientWidth / canvas.clientHeight,
        0.1,
        1000
      );
      const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);

      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(0, 1, 1).normalize();
      scene.add(light);

      // Add ambient light
      const ambientLight = new THREE.AmbientLight(0x404040);
      scene.add(ambientLight);

      camera.position.z = 5;

      function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }
      animate();

      // Handle window resize
      window.addEventListener("resize", () => {
        const canvas = document.getElementById("threeCanvas");
        camera.aspect = canvas.clientWidth / canvas.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      });

      function load3DModel(url) {
        const loader = new THREE.OBJLoader();
        loader.load(
          url,
          (obj) => {
            // Clear existing model if any
            while (scene.children.length > 2) {
              // Keep lights
              scene.remove(scene.children[2]);
            }
            scene.add(obj);

            // Center and scale the model
            const box = new THREE.Box3().setFromObject(obj);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());

            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 2 / maxDim;
            obj.scale.multiplyScalar(scale);

            obj.position.sub(center.multiplyScalar(scale));
          },
          undefined,
          (error) => {
            console.error("Error loading 3D model:", error);
            document.getElementById("result").innerHTML = `
              <div class="bg-red-50 p-4 rounded-lg text-red-700 border border-red-200">
                Error loading 3D model: ${error.message}
              </div>
            `;
          }
        );
      }

      // Connect WebSocket and handle form submission
      connectWebSocket();

      document
        .getElementById("textForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const userInput = document.getElementById("userInput").value;
          const loader = document.getElementById("loader");
          const result = document.getElementById("result");

          result.innerHTML = "";
          loader.classList.remove("hidden");
          document.getElementById("progressBar").style.width = "0%";
          startProgressAnimation();

          try {
            ws.send(
              JSON.stringify({
                action: "generate",
                prompt: userInput,
              })
            );
          } catch (error) {
            stopProgressAnimation();
            loader.classList.add("hidden");
            result.innerHTML = `
            <div class="bg-red-50 p-4 rounded-lg text-red-700 border border-red-200">
              Error sending request: ${error.message}
            </div>
          `;
          }
        });
    </script>
  </body>
</html>
